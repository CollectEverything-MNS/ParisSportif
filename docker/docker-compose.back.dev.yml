name: paris-sportif

services:
  adminer-service:
    container_name: adminer-service
    image: adminer
    restart: unless-stopped
    ports:
      - '${ADMINER_PORT}:8080'
    networks:
      - paris-sportif_net

  api-gateway:
    container_name: api-gateway
    build:
      context: ../
      dockerfile: services/api-gateway/Dockerfile
    command: node services/api-gateway/dist/main.js
    ports:
      - '${API_GATEWAY_PORT}:${API_GATEWAY_PORT}'
    environment:
      NODE_ENV: ${NODE_ENV}
      AUTH_SERVICE_HOST: ${AUTH_SERVICE_HOST}
      AUTH_SERVICE_PORT: ${AUTH_SERVICE_PORT}
      USER_SERVICE_HOST: ${USER_SERVICE_HOST}
      USER_SERVICE_PORT: ${USER_SERVICE_PORT}
      CALENDAR_SERVICE_HOST: ${CALENDAR_SERVICE_HOST}
      CALENDAR_SERVICE_PORT: ${CALENDAR_SERVICE_PORT}
      MATCH_SERVICE_HOST: ${MATCH_SERVICE_HOST}
      MATCH_SERVICE_PORT: ${MATCH_SERVICE_PORT}
      ODDS_SERVICE_HOST: ${ODDS_SERVICE_HOST}
      ODDS_SERVICE_PORT: ${ODDS_SERVICE_PORT}
      WALLET_SERVICE_HOST: ${WALLET_SERVICE_HOST}
      WALLET_SERVICE_PORT: ${WALLET_SERVICE_PORT}
    depends_on:
      - auth-service
      - user-service
      - calendar-service
      - match-service
      - odds-service
      - wallet-service
    networks:
      - paris-sportif_net

  auth-service:
    container_name: auth-service
    build:
      context: ../
      dockerfile: services/auth-service/Dockerfile
    command: node services/auth-service/dist/main.js
    environment:
      NODE_ENV: ${NODE_ENV}
      AUTH_SERVICE_PORT: ${AUTH_SERVICE_PORT}
      AUTH_DB_HOST: ${AUTH_DB_HOST}
      AUTH_DB_PORT: ${AUTH_DB_PORT}
      AUTH_DB_USER: ${AUTH_DB_USER}
      AUTH_DB_PASSWORD: ${AUTH_DB_PASSWORD}
      AUTH_DB_NAME: ${AUTH_DB_NAME}
      RABBITMQ_URL: ${RABBITMQ_URL}
    expose:
      - '${AUTH_SERVICE_PORT}'
    depends_on:
      auth-db:
        condition: service_healthy
    healthcheck:
      test: ['CMD-SHELL', 'nc -z localhost ${AUTH_SERVICE_PORT}']
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks:
      - paris-sportif_net

  user-service:
    container_name: user-service
    build:
      context: ../
      dockerfile: services/user-service/Dockerfile
    command: node services/user-service/dist/main.js
    environment:
      NODE_ENV: ${NODE_ENV}
      USER_SERVICE_PORT: ${USER_SERVICE_PORT}
      USER_DB_HOST: ${USER_DB_HOST}
      USER_DB_PORT: ${USER_DB_PORT}
      USER_DB_USER: ${USER_DB_USER}
      USER_DB_PASSWORD: ${USER_DB_PASSWORD}
      USER_DB_NAME: ${USER_DB_NAME}
    expose:
      - '${USER_SERVICE_PORT}'
    depends_on:
      user-db:
        condition: service_healthy
    healthcheck:
      test: ['CMD-SHELL', 'nc -z localhost ${USER_SERVICE_PORT}']
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks:
      - paris-sportif_net

  match-service:
    container_name: match-service
    build:
      context: ../
      dockerfile: services/match-service/Dockerfile
    command: node services/match-service/dist/main.js
    environment:
      NODE_ENV: ${NODE_ENV}
      MATCH_SERVICE_PORT: ${MATCH_SERVICE_PORT}
      MATCH_DB_HOST: ${MATCH_DB_HOST}
      MATCH_DB_PORT: ${MATCH_DB_PORT}
      MATCH_DB_USER: ${MATCH_DB_USER}
      MATCH_DB_PASSWORD: ${MATCH_DB_PASSWORD}
      MATCH_DB_NAME: ${MATCH_DB_NAME}
    expose:
      - '${MATCH_SERVICE_PORT}'
    depends_on:
      match-db:
        condition: service_healthy
    healthcheck:
      test: ['CMD-SHELL', 'nc -z localhost ${MATCH_SERVICE_PORT}']
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks:
      - paris-sportif_net

  odds-service:
    container_name: odds-service
    build:
      context: ../
      dockerfile: services/odds-service/Dockerfile
    command: node services/odds-service/dist/main.js
    environment:
      NODE_ENV: ${NODE_ENV}
      ODDS_SERVICE_PORT: ${ODDS_SERVICE_PORT}
      ODDS_DB_HOST: ${ODDS_DB_HOST}
      ODDS_DB_PORT: ${ODDS_DB_PORT}
      ODDS_DB_USER: ${ODDS_DB_USER}
      ODDS_DB_PASSWORD: ${ODDS_DB_PASSWORD}
      ODDS_DB_NAME: ${ODDS_DB_NAME}
    expose:
      - '${ODDS_SERVICE_PORT}'
    depends_on:
      odds-db:
        condition: service_healthy
    healthcheck:
      test: ['CMD-SHELL', 'nc -z localhost ${ODDS_SERVICE_PORT}']
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks:
      - paris-sportif_net

  notifier-service:
    container_name: notifier-service
    build:
      context: ../
      dockerfile: services/notifier-service/Dockerfile
    command: node services/notifier-service/dist/main.js
    environment:
      NODE_ENV: ${NODE_ENV}
      RABBITMQ_URL: ${RABBITMQ_URL}
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_SECURE: ${SMTP_SECURE}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_FROM: ${SMTP_FROM}
    restart: unless-stopped
    networks:
      - paris-sportif_net

  calendar-service:
    container_name: calendar-service
    build:
      context: ../
      dockerfile: services/calendar-service/Dockerfile
    command: node services/calendar-service/dist/main.js
    environment:
      NODE_ENV: ${NODE_ENV}
      CALENDAR_SERVICE_PORT: ${CALENDAR_SERVICE_PORT}
      CALENDAR_DB_HOST: ${CALENDAR_DB_HOST}
      CALENDAR_DB_PORT: ${CALENDAR_DB_PORT}
      CALENDAR_DB_USER: ${CALENDAR_DB_USER}
      CALENDAR_DB_PASSWORD: ${CALENDAR_DB_PASSWORD}
      CALENDAR_DB_NAME: ${CALENDAR_DB_NAME}
    expose:
      - '${CALENDAR_SERVICE_PORT}'
    depends_on:
      calendar-db:
        condition: service_healthy
    healthcheck:
      test: ['CMD-SHELL', 'nc -z localhost ${CALENDAR_SERVICE_PORT}']
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks:
      - paris-sportif_net

  wallet-service:
    container_name: wallet-service
    build:
      context: ../
      dockerfile: services/wallet-service/Dockerfile
    command: node services/wallet-service/dist/main.js
    environment:
      NODE_ENV: ${NODE_ENV}
      WALLET_SERVICE_PORT: ${WALLET_SERVICE_PORT}
      WALLET_DB_HOST: ${WALLET_DB_HOST}
      WALLET_DB_PORT: ${WALLET_DB_PORT}
      WALLET_DB_USER: ${WALLET_DB_USER}
      WALLET_DB_PASSWORD: ${WALLET_DB_PASSWORD}
      WALLET_DB_NAME: ${WALLET_DB_NAME}
      RABBITMQ_URL: ${RABBITMQ_URL}
    expose:
      - "${WALLET_SERVICE_PORT}"
    depends_on:
      wallet-db:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "nc -z localhost ${WALLET_SERVICE_PORT}" ]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks:
      - paris-sportif_net


  auth-db:
    image: postgres:16-alpine
    container_name: auth-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${AUTH_DB_USER}
      POSTGRES_PASSWORD: ${AUTH_DB_PASSWORD}
      POSTGRES_DB: ${AUTH_DB_NAME}
    volumes:
      - auth_db_data:/var/lib/postgresql/data
    expose:
      - '${AUTH_DB_PORT}'
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${AUTH_DB_USER} -d ${AUTH_DB_NAME}']
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - paris-sportif_net

  user-db:
    image: postgres:16-alpine
    container_name: user-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${USER_DB_USER}
      POSTGRES_PASSWORD: ${USER_DB_PASSWORD}
      POSTGRES_DB: ${USER_DB_NAME}
    volumes:
      - user_db_data:/var/lib/postgresql/data
    expose:
      - '${USER_DB_PORT}'
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${USER_DB_USER} -d ${USER_DB_NAME}']
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - paris-sportif_net

  match-db:
    image: postgres:16-alpine
    container_name: match-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${MATCH_DB_USER}
      POSTGRES_PASSWORD: ${MATCH_DB_PASSWORD}
      POSTGRES_DB: ${MATCH_DB_NAME}
    volumes:
      - match_db_data:/var/lib/postgresql/data
    expose:
      - '${MATCH_DB_PORT}'
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${MATCH_DB_USER} -d ${MATCH_DB_NAME}']
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - paris-sportif_net

  calendar-db:
    image: postgres:16-alpine
    container_name: calendar-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${CALENDAR_DB_USER}
      POSTGRES_PASSWORD: ${CALENDAR_DB_PASSWORD}
      POSTGRES_DB: ${CALENDAR_DB_NAME}
    volumes:
      - calendar_db_data:/var/lib/postgresql/data
    expose:
      - '${CALENDAR_DB_PORT}'
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${CALENDAR_DB_USER} -d ${CALENDAR_DB_NAME}']
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - paris-sportif_net

  odds-db:
    image: postgres:16-alpine
    container_name: odds-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${ODDS_DB_USER}
      POSTGRES_PASSWORD: ${ODDS_DB_PASSWORD}
      POSTGRES_DB: ${ODDS_DB_NAME}
    volumes:
      - odds_db_data:/var/lib/postgresql/data
    expose:
      - '${ODDS_DB_PORT}'
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${ODDS_DB_USER} -d ${ODDS_DB_NAME}']
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - paris-sportif_net

  wallet-db:
    image: postgres:16-alpine
    container_name: wallet-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${WALLET_DB_USER}
      POSTGRES_PASSWORD: ${WALLET_DB_PASSWORD}
      POSTGRES_DB: ${WALLET_DB_NAME}
    volumes:
      - wallet_db_data:/var/lib/postgresql/data
    expose:
      - "${WALLET_DB_PORT}"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${WALLET_DB_USER} -d ${WALLET_DB_NAME}"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - paris-sportif_net

volumes:
  auth_db_data:
  calendar_db_data:
  match_db_data:
  user_db_data:
  odds_db_data:
  wallet_db_data:

networks:
  paris-sportif_net:
    driver: bridge
